name: CI - (base)
env:
  MIDNIGHTCI_PACKAGES_WRITE: ${{ secrets.MIDNIGHTCI_PACKAGES_WRITE }}

permissions:
  contents: read
  issues: read
  checks: write
  pull-requests: write

on:
  workflow_dispatch:
  workflow_call:
    inputs:
      workspace:
        type: string
        description: The workspace folder that should be the target of the workflow.
        required: true
      node-version-file:
        type: string
        required: false
        default: '.nvmrc' # Default to the Node.js version defined in the repo root.
      coverage-files:
        type: string
        required: false
        default: ''
      create-package-artifacts:
        type: boolean
        description: A flag indicating whether the compiled packages should be created and attached to the build.
        required: false
        default: false

jobs:
  ci:
    name: Build, Lint and Test
    runs-on: ubuntu-latest
    timeout-minutes: 15
    defaults:
      run:
        working-directory: ./${{ inputs.workspace }} # Workspace name has affinity to a folder in the root of the repo.
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8  # ratchet:actions/checkout@v5

      - name: Load environment variables
        run: |
          export $(grep -v '^#' .github/env/global.env | xargs)
          for var in $(cut -d= -f1 .github/env/global.env); do
            echo "$var=${!var}" >> $GITHUB_ENV
          done

      - name: Log in to GitHub Container registry
        uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef # ratchet:docker/login-action@v3
        with:
          registry: 'https://ghcr.io'
          username: ${{ github.actor }}
          password: ${{ secrets.MIDNIGHTCI_PACKAGES_WRITE }}

      - name: Set up Node.js
        uses: actions/setup-node@2028fbc5c25fe9cf00d9f06a71cc4710d4507903 # ratchet:actions/setup-node@v4
        with:
          always-auth: true
          registry-url: https://npm.pkg.github.com/
          scope: '@midnight-ntwrk'
          node-version-file: ${{ inputs.node-version-file }}
        env:
          NODE_AUTH_TOKEN: ${{ secrets.MIDNIGHTCI_PACKAGES_WRITE }}

      - name: Configure yarn
        run: yarn config set 'npmScopes.midnight-ntwrk.npmAuthToken' ${{ secrets.MIDNIGHTCI_PACKAGES_WRITE }}

      - name: Cache Turbo and Yarn dependencies
        uses: actions/cache@0400d5f644dc74513175e3cd8d07132dd4860809 # v4.2.4
        with:
          path: |
            **/node_modules
            ~/.yarn
            .turbo
          key: turbo-${{ runner.os }}-${{ hashFiles('**/yarn.lock') }}-${{ hashFiles('**/turbo.json') }}
          restore-keys: |
            turbo-${{ runner.os }}-

      - name: Install dependencies
        run: |
          yarn install

      - name: Run build
        run: yarn build --cache-dir ./turbo
        env:
          GITHUB_TOKEN: ${{ secrets.MIDNIGHTCI_PACKAGES_WRITE }}

      - name: Run linter
        run: yarn lint

      - name: Run tests
        run: |
          yarn test --concurrency 1 --cache-dir ./turbo
        env:
          GITHUB_TOKEN: ${{ secrets.MIDNIGHTCI_PACKAGES_WRITE }}

      - name: Aggregate coverage reports
        run: |
          mkdir -p .nyc_output
          find . -type f -name 'coverage-final.json' -exec cp {} .nyc_output/ \;
          npx --yes nyc merge .nyc_output coverage.json
          npx --yes nyc report --reporter=html --report-dir=coverage --temp-dir=.nyc_output
          rm -rf .nyc_output

      - name: Merge report as ZIP
        run: |
          #ArtiomTr/jest-coverage-report-action@v2 has a bug, this is temp solution
          mv coverage coverage_$(date +"%Y%m%d%H%M%S")
          zip -r coverage-${{ inputs.workspace }}.zip coverage*

      - name: Upload Artifact
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # ratchet:actions/upload-artifact@v4
        with:
          name: Coverage Report ${{ inputs.workspace }}
          path: ${{ inputs.workspace }}/coverage-${{ inputs.workspace }}.zip

      - name: Publish Test Coverage
        if: ${{ inputs.coverage-files }} # Publish the comment if we have received coverage files
        uses: MishaKav/jest-coverage-comment@174f9cbf582b7cc2a7a3acce14dcfc8362e9d37f # ratchet:MishaKav/jest-coverage-comment@v1
        with:
          hide-comment: false
          unique-id-for-comment: ${{ inputs.workspace }}-coverage
          multiple-files: ${{ inputs.coverage-files }}

      - name: Pack and Upload Package Artifacts
        if: ${{ inputs.create-package-artifacts }}
        uses: ./.github/actions/create-package-artifacts
        with:
          package-archive-name: ${{ inputs.workspace }}
          working-directory: ${{ inputs.workspace }}
